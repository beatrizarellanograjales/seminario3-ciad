# Cargar la base de datos
df = pd.read_stata("enoe_23t4.dta")

# Mostrar las primeras filas
df.head()

# Paso 1: Obtener una muestra aleatoria representativa de n=1000
# Verificar si hay valores nulos en la columna de ponderaci贸n
print("Valores nulos en 'fac_tri':", df['fac_tri'].isnull().sum())

# Eliminar filas con valores nulos en 'fac_tri' antes de hacer el muestreo ponderado
df = df.dropna(subset=['fac_tri'])

# Paso 1: Obtener una muestra aleatoria representativa de n=1000 con ponderaci贸n
df_sample = df.sample(n=1000, weights=df['fac_tri'], random_state=42)

# Mostrar las primeras filas de la muestra
print(df_sample.head())


#Paso 2: Tabular la variable de sexo donde hombres=1 y mujeres=2 (antes y despu茅s de la muestra n=1000 / eliminando advertencia
    # Verificar los valores 煤nicos en la columna "sex" para confirmar c贸mo est谩n codificados
print("Valores 煤nicos en 'sex':", df['sex'].unique())

# Si "sex" es categ贸rica, usamos .cat.rename_categories() en lugar de .replace()
if isinstance(df['sex'].dtype, pd.CategoricalDtype):
    df['sex'] = df['sex'].cat.rename_categories({'Hombre': 1, 'Mujer': 2})
    df_sample['sex'] = df_sample['sex'].cat.rename_categories({'Hombre': 1, 'Mujer': 2})
else:
    df['sex'] = df['sex'].replace({'Hombre': 1, 'Mujer': 2})
    df_sample['sex'] = df_sample['sex'].replace({'Hombre': 1, 'Mujer': 2})

# Funci贸n para tabular la variable "sexo"
def tabular_sexo(df, nombre):
    tab = df['sex'].value_counts(normalize=True)  # Calcula proporciones
    return pd.DataFrame({'Sexo': tab.index, 'Proporci贸n': tab.values, 'Muestra': nombre})

# Tabulaci贸n en la poblaci贸n total antes del muestreo
original_tab = tabular_sexo(df, "Poblaci贸n total")

# Tabulaci贸n en la muestra de 1000 despu茅s del muestreo
muestra_tab = tabular_sexo(df_sample, "Muestra de 1000")

# Concatenar los resultados para comparaci贸n
tabla_comparativa = pd.concat([original_tab, muestra_tab], ignore_index=True)

# Mostrar la tabla comparativa
print(tabla_comparativa)


#Paso 2: Tabular la variable de sexo donde hombres=1 y mujeres=2 (antes y despu茅s de la muestra n=1000 / Representaci贸n en una Tabla
import pandas as pd

# Crear una tabla con formato mejorado usando Pandas Styler
styled_table = tabla_comparativa.style.set_properties(**{
    'background-color': 'white',
    'color': 'black',
    'border': '1px solid black'
}).set_caption("Distribuci贸n de Hombres y Mujeres en la Poblaci贸n y la Muestra")

# Mostrar la tabla con estilo
styled_table


#paso 2: Tabular la variable de sexo donde hombres=1 y mujeres=2 (antes y despu茅s de la muestra n=1000) / Representaci贸n en un Gr谩fico de Barras
import matplotlib.pyplot as plt
import seaborn as sns

# Definir colores personalizados: Azul Rey (#1f77b4) para hombres, Morado (#9467bd) para mujeres
custom_palette = {1: "#1f77b4", 2: "#9467bd"}  # Hombres: Azul Rey, Mujeres: Morado

# Crear el gr谩fico de barras con colores
plt.figure(figsize=(8,5))
sns.barplot(data=tabla_comparativa, x="Muestra", y="Proporci贸n", hue="Sexo", palette=custom_palette)

# Agregar t铆tulos y etiquetas
plt.title("Distribuci贸n de Hombres (1) y Mujeres (2) antes y despu茅s del muestreo")
plt.ylabel("Proporci贸n")
plt.xlabel("Grupo de An谩lisis")
plt.legend(title="Sexo", labels=["Hombres", "Mujeres"])

# Mostrar gr谩fico
plt.show()



#Paso 3: calcula los intervalos de confianza (IC) al 95% para las proporciones de hombres y mujeres en la poblaci贸n total y la muestra de 1000.
    
import statsmodels.stats.proportion as smp
import pandas as pd

# Funci贸n para calcular intervalos de confianza de proporciones
def calcular_ic(tab, n):
    resultados = []
    for _, row in tab.iterrows():
        sexo = row['Sexo']
        prop = row['Proporci贸n']
        count = int(prop * n)  # Convertir la proporci贸n a n煤mero de casos
        ic_low, ic_high = smp.proportion_confint(count, nobs=n, alpha=0.05, method='wilson')

        resultados.append({'Sexo': sexo, 'IC Bajo': ic_low, 'IC Alto': ic_high, 'Muestra': row['Muestra']})
    
    return pd.DataFrame(resultados)

# Calcular IC para la poblaci贸n total
ic_original = calcular_ic(original_tab, len(df))

# Calcular IC para la muestra de 1000
ic_muestra = calcular_ic(muestra_tab, 1000)

# Concatenar resultados
ic_resultados = pd.concat([ic_original, ic_muestra], ignore_index=True)

# Mostrar la tabla con los intervalos de confianza
print(ic_resultados)


#Paso 3: calcula los intervalos de confianza (IC) al 95% para las proporciones de hombres y mujeres en la poblaci贸n total y la muestra de 1000.  / Representaci贸n en un Gr谩fico de Puntos con L铆neas de IC

plt.figure(figsize=(8,5))

# Graficar los intervalos de confianza
for i, row in ic_resultados.iterrows():
    plt.plot([row["Muestra"], row["Muestra"]], [row["IC Bajo"], row["IC Alto"]],
             color="#444444", linewidth=2)  # L铆nea vertical del intervalo

# Graficar los puntos de la proporci贸n
sns.scatterplot(data=ic_resultados, x="Muestra", y="IC Bajo", hue="Sexo", s=100, palette={1: "#1f77b4", 2: "#9467bd"})
sns.scatterplot(data=ic_resultados, x="Muestra", y="IC Alto", hue="Sexo", s=100, palette={1: "#1f77b4", 2: "#9467bd"})

# Etiquetas
plt.title("Distribuci贸n de los Intervalos de Confianza (IC 95%) por Sexo")
plt.ylabel("Proporci贸n con Intervalo de Confianza")
plt.xlabel("Grupo de An谩lisis")
plt.legend(title="Sexo", labels=["Hombres", "Mujeres"])

plt.show()



# Error----- Paso 4:  Obtener la Poblaci贸n ocupada en M茅xico por g茅nero: Para el pais y para la entidad de Sonora. Sonora tiene la clave entidad=26  ///  ERROR en el sistema de filtrado con

import pandas as pd

# Filtrar solo la poblaci贸n ocupada en todo el pa铆s
poblacion_ocupada_mexico = df[df['clase2'] == 'Poblaci贸n ocupada']

# Filtrar solo la poblaci贸n ocupada en Sonora (clave entidad = 26)
poblacion_ocupada_sonora = poblacion_ocupada_mexico[poblacion_ocupada_mexico['ent'] == 26]


# Contar la cantidad de hombres y mujeres en M茅xico
ocupacion_mexico = poblacion_ocupada_mexico['sex'].value_counts(normalize=True).reset_index()
ocupacion_mexico.columns = ['Sexo', 'Proporci贸n']
ocupacion_mexico['Muestra'] = 'M茅xico'

# Contar la cantidad de hombres y mujeres en Sonora
ocupacion_sonora = poblacion_ocupada_sonora['sex'].value_counts(normalize=True).reset_index()
ocupacion_sonora.columns = ['Sexo', 'Proporci贸n']
ocupacion_sonora['Muestra'] = 'Sonora'

# Concatenar resultados
ocupacion_resultados = pd.concat([ocupacion_mexico, ocupacion_sonora], ignore_index=True)

# Mostrar resultados
from IPython.display import display
display(ocupacion_resultados)



print("Valores 煤nicos en 'sex' despu茅s del filtrado en M茅xico:", poblacion_ocupada_mexico['sex'].unique())
print("Valores 煤nicos en 'sex' despu茅s del filtrado en Sonora:", poblacion_ocupada_sonora['sex'].unique())


print("Valores 煤nicos en 'sex' despu茅s del filtrado en M茅xico:", poblacion_ocupada_mexico['sex'].unique())
print("Valores 煤nicos en 'sex' despu茅s del filtrado en Sonora:", poblacion_ocupada_sonora['sex'].unique())


poblacion_ocupada_mexico['sex'] = poblacion_ocupada_mexico['sex'].replace({'Hombre': 1, 'Mujer': 2})
poblacion_ocupada_sonora['sex'] = poblacion_ocupada_sonora['sex'].replace({'Hombre': 1, 'Mujer': 2})


print(df['clase2'].unique())  # Verifica los valores 煤nicos


#  ERROR ----- Paso 4:  Obtener la Poblaci贸n ocupada en M茅xico por g茅nero: Para el pais y para la entidad de Sonora. Sonora tiene la clave entidad=26  ///  ERROR en el sistema de filtrado con

import pandas as pd

# Filtrar solo la poblaci贸n ocupada en todo el pa铆s
poblacion_ocupada_mexico = df[df['clase2'] == 'Poblaci贸n ocupada']

# Filtrar solo la poblaci贸n ocupada en Sonora (clave entidad = 26)
poblacion_ocupada_sonora = poblacion_ocupada_mexico[poblacion_ocupada_mexico['ent'] == 26]


# Contar la cantidad de hombres y mujeres en M茅xico
ocupacion_mexico = poblacion_ocupada_mexico['sex'].value_counts(normalize=True).reset_index()
ocupacion_mexico.columns = ['Sexo', 'Proporci贸n']
ocupacion_mexico['Muestra'] = 'M茅xico'

# Contar la cantidad de hombres y mujeres en Sonora
ocupacion_sonora = poblacion_ocupada_sonora['sex'].value_counts(normalize=True).reset_index()
ocupacion_sonora.columns = ['Sexo', 'Proporci贸n']
ocupacion_sonora['Muestra'] = 'Sonora'

# Concatenar resultados
ocupacion_resultados = pd.concat([ocupacion_mexico, ocupacion_sonora], ignore_index=True)

# Mostrar resultados
from IPython.display import display
display(ocupacion_resultados)


# paso 4:  Obtener la Poblaci贸n ocupada en M茅xico por g茅nero: Para el pais y para la entidad de Sonora. Sonora tiene la clave entidad=26
#  Eliminar espacios extra y convertir a min煤sculas en 'clase2' para evitar errores de filtrado
df['clase2'] = df['clase2'].str.strip().str.lower()

#  Filtrar solo la poblaci贸n ocupada en todo el pa铆s
poblacion_ocupada_mexico = df[df['clase2'] == 'poblaci贸n ocupada']

#  Verificar valores 煤nicos en 'ent' antes de filtrar Sonora
print("Valores 煤nicos en 'ent':", df['ent'].unique())

#  Filtrar solo la poblaci贸n ocupada en Sonora (clave entidad = 26)
poblacion_ocupada_sonora = poblacion_ocupada_mexico[poblacion_ocupada_mexico['ent'] == 26]

#  Asegurar que 'sex' tiene valores v谩lidos antes de contar
poblacion_ocupada_mexico = poblacion_ocupada_mexico.dropna(subset=['sex'])
poblacion_ocupada_sonora = poblacion_ocupada_sonora.dropna(subset=['sex'])

#  Verificar los valores 煤nicos en 'sex' despu茅s del filtrado
print("Valores 煤nicos en 'sex' despu茅s del filtrado en M茅xico:", poblacion_ocupada_mexico['sex'].unique())
print("Valores 煤nicos en 'sex' despu茅s del filtrado en Sonora:", poblacion_ocupada_sonora['sex'].unique())

#  Contar la cantidad de hombres y mujeres en M茅xico
if len(poblacion_ocupada_mexico) > 0:
    ocupacion_mexico = poblacion_ocupada_mexico['sex'].value_counts(normalize=True).reset_index()
else:
    ocupacion_mexico = pd.DataFrame({'Sexo': [1, 2], 'Proporci贸n': [0, 0]})

ocupacion_mexico.columns = ['Sexo', 'Proporci贸n']
ocupacion_mexico['Muestra'] = 'M茅xico'

#  Contar la cantidad de hombres y mujeres en Sonora
if len(poblacion_ocupada_sonora) > 0:
    ocupacion_sonora = poblacion_ocupada_sonora['sex'].value_counts(normalize=True).reset_index()
else:
    ocupacion_sonora = pd.DataFrame({'Sexo': [1, 2], 'Proporci贸n': [0, 0]})

ocupacion_sonora.columns = ['Sexo', 'Proporci贸n']
ocupacion_sonora['Muestra'] = 'Sonora'

#  Concatenar resultados
ocupacion_resultados = pd.concat([ocupacion_mexico, ocupacion_sonora], ignore_index=True)

#  Mostrar resultados
display(ocupacion_resultados)

#ERROR ----Paso 5: Obtener la Poblaci贸n ocupada en M茅xico por g茅nero antes y despues del muestreo: Para el pais y para la entidad de Sonora. Sonora tiene la clave entidad=26
import pandas as pd
from IPython.display import display

#  Asegurar que 'clase2' no tenga espacios extra ni errores de formato
df['clase2'] = df['clase2'].str.strip().str.lower()

#  Filtrar solo la poblaci贸n ocupada en todo el pa铆s
poblacion_ocupada_mexico = df[df['clase2'] == 'poblaci贸n ocupada']

#  Filtrar solo la poblaci贸n ocupada en Sonora (clave entidad = 26)
poblacion_ocupada_sonora = poblacion_ocupada_mexico[poblacion_ocupada_mexico['ent'] == 26]

#  Asegurar que 'sex' tiene valores v谩lidos antes de contar
poblacion_ocupada_mexico = poblacion_ocupada_mexico.dropna(subset=['sex'])
poblacion_ocupada_sonora = poblacion_ocupada_sonora.dropna(subset=['sex'])

#  Contar la cantidad de hombres y mujeres en M茅xico antes del muestreo
ocupacion_mexico_original = poblacion_ocupada_mexico['sex'].value_counts(normalize=True).reset_index()
ocupacion_mexico_original.columns = ['Sexo', 'Proporci贸n']
ocupacion_mexico_original['Muestra'] = 'M茅xico - Antes del Muestreo'

#  Contar la cantidad de hombres y mujeres en Sonora antes del muestreo
ocupacion_sonora_original = poblacion_ocupada_sonora['sex'].value_counts(normalize=True).reset_index()
ocupacion_sonora_original.columns = ['Sexo', 'Proporci贸n']
ocupacion_sonora_original['Muestra'] = 'Sonora - Antes del Muestreo'

#  Generar la muestra aleatoria de 1000 casos con ponderaci贸n
df_sample = df.sample(n=1000, weights=df['fac_tri'], random_state=42)

#  Filtrar solo la poblaci贸n ocupada dentro de la muestra
poblacion_ocupada_mexico_muestra = df_sample[df_sample['clase2'] == 'poblaci贸n ocupada']
poblacion_ocupada_sonora_muestra = poblacion_ocupada_mexico_muestra[poblacion_ocupada_mexico_muestra['ent'] == 26]

#  Contar la cantidad de hombres y mujeres en M茅xico despu茅s del muestreo
ocupacion_mexico_muestra = poblacion_ocupada_mexico_muestra['sex'].value_counts(normalize=True).reset_index()
ocupacion_mexico_muestra.columns = ['Sexo', 'Proporci贸n']
ocupacion_mexico_muestra['Muestra'] = 'M茅xico - Despu茅s del Muestreo'

#  Contar la cantidad de hombres y mujeres en Sonora despu茅s del muestreo
ocupacion_sonora_muestra = poblacion_ocupada_sonora_muestra['sex'].value_counts(normalize=True).reset_index()
ocupacion_sonora_muestra.columns = ['Sexo', 'Proporci贸n']
ocupacion_sonora_muestra['Muestra'] = 'Sonora - Despu茅s del Muestreo'

#  Concatenar resultados antes y despu茅s del muestreo
ocupacion_resultados = pd.concat(
    [ocupacion_mexico_original, ocupacion_sonora_original, ocupacion_mexico_muestra, ocupacion_sonora_muestra],
    ignore_index=True
)

#  Mostrar los resultados
display(ocupacion_resultados)


# Paso 5: Obtener la Poblaci贸n ocupada en M茅xico por g茅nero antes y despues del muestreo: Para el pais y para la entidad de Sonora. Sonora tiene la clave entidad=26
import pandas as pd
import pandas as pd

# Cargar la base de datos Stata (.dta)
df = pd.read_stata('enoe_23t4.dta')

# Filtrar solo la poblaci贸n ocupada
df_ocupada = df[df['clase2'] == 'Poblaci鲁n ocupada']

# Filtrar la poblaci贸n ocupada en todo M茅xico y en Sonora
mexico = df_ocupada.copy()
sonora = df_ocupada[df_ocupada['ent'] == 'Sonora']

# Funci贸n para mostrar la distribuci贸n por g茅nero en formato tabla
def mostrar_distribucion(data, titulo):
    conteo = data['sex'].value_counts().rename_axis('G茅nero').reset_index(name='Cantidad')
    print(f"\n{titulo}")
    print(conteo.to_string(index=False))
    return conteo

# Mostrar distribuci贸n antes de la muestra
distribucion_mexico = mostrar_distribucion(mexico, 'Distribuci贸n de Poblaci贸n Ocupada en M茅xico')
distribucion_sonora = mostrar_distribucion(sonora, 'Distribuci贸n de Poblaci贸n Ocupada en Sonora')

# Tomar muestra aleatoria representativa de n=1000
muestra_mexico = mexico.sample(n=1000, random_state=42)
muestra_sonora = sonora.sample(n=1000, random_state=42)

# Mostrar distribuci贸n despu茅s de la muestra
distribucion_muestra_mexico = mostrar_distribucion(muestra_mexico, 'Muestra de Poblaci贸n Ocupada en M茅xico (n=1000)')
distribucion_muestra_sonora = mostrar_distribucion(muestra_sonora, 'Muestra de Poblaci贸n Ocupada en Sonora (n=1000)')



#Paso 5: Obtener la Poblaci贸n ocupada en M茅xico por g茅nero antes y despues del muestreo: Para el pais y para la entidad de Sonora. Sonora tiene la clave entidad=26
#Grafico de barras / opci贸n 2 de visualizaci贸n 
import pandas as pd
import matplotlib.pyplot as plt

# Cargar la base de datos Stata (.dta)
df = pd.read_stata('enoe_23t4.dta')

# Filtrar solo la poblaci贸n ocupada
df_ocupada = df[df['clase2'] == 'Poblaci鲁n ocupada']

# Filtrar la poblaci贸n ocupada en todo M茅xico y en Sonora
mexico = df_ocupada.copy()
sonora = df_ocupada[df_ocupada['ent'] == 'Sonora']

# Funci贸n para mostrar la distribuci贸n por g茅nero
def mostrar_distribucion(data, titulo):
    conteo = data['sex'].value_counts()
    etiquetas = ['Hombres', 'Mujeres']
    plt.figure(figsize=(6,4))
    plt.bar(etiquetas, conteo, color=['blue', 'pink'])
    plt.xlabel('G茅nero')
    plt.ylabel('Cantidad')
    plt.title(titulo)
    plt.show()
    print(conteo)

# Mostrar distribuci贸n antes de la muestra
distribucion_mexico = mostrar_distribucion(mexico, 'Distribuci贸n de Poblaci贸n Ocupada en M茅xico')
distribucion_sonora = mostrar_distribucion(sonora, 'Distribuci贸n de Poblaci贸n Ocupada en Sonora')

# Tomar muestra aleatoria representativa de n=1000
muestra_mexico = mexico.sample(n=1000, random_state=42)
muestra_sonora = sonora.sample(n=1000, random_state=42)

# Mostrar distribuci贸n despu茅s de la muestra
distribucion_muestra_mexico = mostrar_distribucion(muestra_mexico, 'Muestra de Poblaci贸n Ocupada en M茅xico (n=1000)')
distribucion_muestra_sonora = mostrar_distribucion(muestra_sonora, 'Muestra de Poblaci贸n Ocupada en Sonora (n=1000)')


# Respuesta a la preguntas del punto 6

import pandas as pd
import numpy as np
import scipy.stats as stats

# Cargar la base de datos Stata (.dta)
df = pd.read_stata('enoe_23t4.dta')

# Filtrar solo la poblaci贸n ocupada
df_ocupada = df[df['clase2'] == 'Poblaci鲁n ocupada']

# Filtrar la poblaci贸n ocupada en todo M茅xico y en Sonora
mexico = df_ocupada.copy()
sonora = df_ocupada[df_ocupada['ent'] == 'Sonora']

# Funci贸n para mostrar la distribuci贸n por g茅nero en formato tabla
def mostrar_distribucion(data, titulo):
    conteo = data['sex'].value_counts().rename_axis('G茅nero').reset_index(name='Cantidad')
    print(f"\n{titulo}")
    print(conteo.to_string(index=False))
    return conteo

# Mostrar distribuci贸n antes de la muestra
distribucion_mexico = mostrar_distribucion(mexico, 'Distribuci贸n de Poblaci贸n Ocupada en M茅xico')
distribucion_sonora = mostrar_distribucion(sonora, 'Distribuci贸n de Poblaci贸n Ocupada en Sonora')

# Tomar muestra aleatoria representativa de n=1000
muestra_mexico = mexico.sample(n=1000, random_state=42)
muestra_sonora = sonora.sample(n=1000, random_state=42)

# Mostrar distribuci贸n despu茅s de la muestra
distribucion_muestra_mexico = mostrar_distribucion(muestra_mexico, 'Muestra de Poblaci贸n Ocupada en M茅xico (n=1000)')
distribucion_muestra_sonora = mostrar_distribucion(muestra_sonora, 'Muestra de Poblaci贸n Ocupada en Sonora (n=1000)')

# 1. Comparar proporciones entre tabulados
def comparar_proporciones(distribucion_total, distribucion_muestra, titulo):
    proporciones_total = distribucion_total['Cantidad'] / distribucion_total['Cantidad'].sum()
    proporciones_muestra = distribucion_muestra['Cantidad'] / distribucion_muestra['Cantidad'].sum()
    comparacion = pd.DataFrame({'G茅nero': distribucion_total['G茅nero'], 'Proporci贸n Total': proporciones_total, 'Proporci贸n Muestra': proporciones_muestra})
    print(f"\nComparaci贸n de proporciones - {titulo}")
    print(comparacion.to_string(index=False))
    return comparacion

comparar_proporciones(distribucion_mexico, distribucion_muestra_mexico, 'M茅xico')
comparar_proporciones(distribucion_sonora, distribucion_muestra_sonora, 'Sonora')

# 2. Calcular intervalos de confianza del 95%
def calcular_intervalo_confianza(distribucion, n):
    conteo = distribucion['Cantidad'].values
    total = conteo.sum()
    proporciones = conteo / total
    errores = np.sqrt((proporciones * (1 - proporciones)) / n)  # Error est谩ndar
    intervalo = [(p - 1.96 * e, p + 1.96 * e) for p, e in zip(proporciones, errores)]
    intervalos_df = pd.DataFrame({'G茅nero': distribucion['G茅nero'], 'Intervalo de Confianza': intervalo})
    print("\nIntervalos de Confianza (95%)")
    print(intervalos_df.to_string(index=False))
    return intervalos_df

calcular_intervalo_confianza(distribucion_muestra_mexico, 1000)
calcular_intervalo_confianza(distribucion_muestra_sonora, 1000)

# 3. Ventajas del muestreo aleatorio
def ventajas_muestreo():
    ventajas = [
        "Permite generalizar resultados a la poblaci贸n total.",
        "Reduce el sesgo en la selecci贸n de datos.",
        "Es eficiente en t茅rminos de costos y tiempo.",
        "Asegura una distribuci贸n representativa de la poblaci贸n ocupada."
    ]
    print("\nVentajas del Muestreo Aleatorio:")
    for v in ventajas:
        print(f"- {v}")

ventajas_muestreo()